<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Medsys Technologies ‚Ä¢ Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>
  <script defer src="app.js"></script>
</head>
<body>
<div class="app-shell">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <img src="img/logo-sidebar.png" alt="Logo Medsys" />
      <div>
        <h1>Medsys<small>Technologies</small></h1>
      </div>
    </div>
    <nav class="nav" id="nav">
      <a href="#" data-section="dashboard" class="active">üè† Inicio</a>
      <a href="#" data-section="productos">üì¶ Productos</a>
      <a href="#" data-section="materiales">üß∞ Materiales</a>
      <a href="#" data-section="proveedores">ü§ù Proveedores</a>
      <a href="#" data-section="ensambles">üß™ Ensambles</a>
      <a href="#" data-section="scrap">üóëÔ∏è Scrap</a>
      <a href="#" data-section="personal">üë• Personal</a>
      <a href="#" data-section="ventas">üßæ Ventas</a> <!-- Ventas tab -->
      <a href="#" data-section="reportes">üìà Reportes</a>
      <a href="#" data-section="config">‚öôÔ∏è Configuraci√≥n</a>
    </nav>
    <div class="bottom">
      <a class="nav-link nav" href="#" id="logout">üö™ Cerrar sesi√≥n</a>
    </div>
  </aside>

  <main>
    <header class="topbar">
      <button class="button ghost menu-btn" id="menuBtn" aria-label="Mostrar men√∫" style="display:none">‚ò∞</button>
      <div class="search">
        <input class="input" id="globalSearch" placeholder="Buscar productos, materiales, √≥rdenes‚Ä¶"/>
        <button class="button secondary" id="searchBtn">Buscar</button>
      </div>
      <div class="user-chip">
        <div class="avatar" aria-hidden="true"></div>
        <span id="usernameChip">Usuario</span>
      </div>
    </header>

    <div class="container">
      <!-- Inicio -->
        <div class="kpis">
          <button class="kpi is-action" data-target="productos" aria-label="Ir a Productos">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-body">
              <h3>Total de √≠tems</h3>
              <div class="value" id="kpiDevices">‚Äì</div>
              <div class="subtext">Inventario total</div>
            </div>
          </button>

          <button class="kpi is-action good" data-target="productos" aria-label="Ver productos con stock">
            <div class="kpi-icon">‚úÖ</div>
            <div class="kpi-body">
              <h3>Con stock</h3>
              <div class="value" id="kpiStock">‚Äì</div>
              <div class="subtext">Disponibles para venta</div>
            </div>
          </button>

          <button class="kpi is-action warn" data-target="ensambles" aria-label="Ir a Ensambles">
            <div class="kpi-icon">üß™</div>
            <div class="kpi-body">
              <h3>√ìrdenes pendientes</h3>
              <div class="value" id="kpiPending">‚Äì</div>
              <div class="subtext">En proceso</div>
            </div>
          </button>

          <button class="kpi is-action bad" data-target="scrap" aria-label="Ir a Scrap">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-body">
              <h3>√ìrdenes rechazadas</h3>
              <div class="value" id="kpiRejects">‚Äì</div>
              <div class="subtext">√öltimos 30 d√≠as</div>
            </div>
          </button>
        </div>

        <div class="grid-2">
          <div class="card" style="padding:20px">
            <h3 style="margin:0 0 10px 0">√ìrdenes recientes</h3>
            <table class="table" id="ordersTable">
              <thead><tr><th>ID</th><th>√çtem</th><th>Cant.</th><th>Estado</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card" style="padding:20px">
            <h3 style="margin:0 0 10px 0">Stock por categor√≠a</h3>
            <div id="miniChart" class="placeholder">[gr√°fico demo]</div>
          </div>
        </div>
      </section>

      <!-- Productos -->
      <section id="productos" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Productos</h3>
          <button class="button" id="addProducto">+ Agregar</button>
        </div>
        <table class="table" id="productosTable">
          <thead><tr><th>ID</th><th>Nombre</th><th>Riesgo</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Materiales -->
      <section id="materiales" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Materiales</h3>
          <button class="button" id="addMaterial">+ Agregar</button>
        </div>
        <table class="table" id="materialesTable">
          <thead><tr><th>SKU</th><th>Nombre</th><th>Costo unitario</th><th>Stock</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Proveedores -->
      <section id="proveedores" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Proveedores</h3>
          <button class="button" id="addProveedor">+ Agregar</button>
        </div>
        <table class="table" id="proveedoresTable">
          <thead><tr><th>ID</th><th>Nombre</th><th>Contacto</th><th>Tel√©fono</th><th>Email</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Ensambles -->
      <section id="ensambles" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Ensambles</h3>
          <button class="button" id="addEnsamble">+ Registrar</button>
        </div>
        <table class="table" id="ensamblesTable">
          <thead><tr><th>ID</th><th>Producto</th><th>Componentes</th><th>Fecha</th><th>Responsable</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Scrap -->
      <section id="scrap" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Scrap</h3>
          <button class="button" id="addScrap">+ Registrar</button>
        </div>
        <table class="table" id="scrapTable">
          <thead><tr><th>ID</th><th>√çtem</th><th>Causa</th><th>Cant.</th><th>Fecha</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Personal -->
      <section id="personal" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Personal</h3>
          <button class="button" id="addPersona">+ Agregar</button>
        </div>
        <table class="table" id="personalTable">
          <thead><tr><th>ID</th><th>Nombre</th><th>Rol</th><th>Turno</th><th>Correo</th><th>Tel√©fono</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Ventas -->
      <section id="ventas" class="section card" style="display:none;padding:20px">
        <div class="section-head">
          <h3>Ventas</h3>
          <button class="button" id="addVenta">+ Registrar</button>
        </div>
        <table class="table" id="ventasTable">
          <thead>
            <tr><th>ID</th><th>Fecha</th><th>Cliente</th><th>Total</th><th>Items</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Reportes -->
      <section id="reportes" class="section card" style="display:none;padding:20px">
        <h3 style="margin-top:0">Reportes</h3>
        <p>Exportaciones r√°pidas (demo).</p>
        <button class="button" id="exportCsv">Exportar Inventario CSV</button>
      </section>

      <!-- Configuraci√≥n -->
      <section id="config" class="section card" style="display:none;padding:20px">
        <h3 style="margin-top:0">Configuraci√≥n</h3>
        <div class="form-row">
          <label>Color de tema</label>
          <input type="color" id="themePicker" value="#0077C8"/>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Modal gen√©rico -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <header>
      <h3 id="modalTitle">Formulario</h3>
      <button class="button ghost" id="modalClose">Cerrar</button>
    </header>
    <form id="modalForm">
      <div class="form-grid" id="modalFields"></div>
      <footer>
        <button type="button" class="button ghost" id="modalCancel">Cancelar</button>
        <button type="submit" class="button" id="modalSubmit">Guardar</button>
      </footer>
    </form>
  </div>
</div>

<div class="notification" id="toast" role="status" aria-live="polite">
  <span id="toastMsg">Guardado</span>
  <button class="close" aria-label="Cerrar" onclick="document.getElementById('toast').classList.remove('show')">√ó</button>
</div>

<!-- Template de campo para Ventas: ID_Personal -->
<template id="tpl-venta-personal">
  <div class="form-row" data-field="venta-personal">
    <label for="ventaPersonal">Atendido por</label>
    <select id="ventaPersonal" name="idPersonal">
      <option value="">Cargando‚Ä¶</option>
    </select>
  </div>
</template>

<!-- Helper: inyecta el selector de Personal al abrir el modal de Ventas -->
<script>
(function(){
  const API_BASE = (window.API_BASE) ? window.API_BASE : 'http://localhost:3000/api';

  async function loadPersonalOptions(sel){
    try{
      const res = await fetch(API_BASE + '/personal');
      const data = await res.json();
      sel.innerHTML = (Array.isArray(data) ? data : []).map(p => {
        const rol = (p.Rol || p.Cargo || '').toString().trim();
        return `<option value="${p.ID_Personal}">${p.Nombre}${rol ? ' ('+rol+')' : ''}</option>`;
      }).join('') || '<option value="">(Sin personal)</option>';

      // Preseleccionar del token, si existe
      try{
        const token = sessionStorage.getItem('medsys_token') || localStorage.getItem('medsys_token');
        const payload = token ? JSON.parse(atob(token)) : null;
        const pre = payload && payload.user && payload.user.idPersonal;
        if (pre) sel.value = String(pre);
      }catch(_e){}
    }catch(e){
      sel.innerHTML = '<option value="">Error cargando personal</option>';
      console.error('Carga de personal fall√≥:', e);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('addVenta');
    if (!btn) return;

    btn.addEventListener('click', async () => {
      // Da tiempo a app.js de abrir el modal y dibujar campos
      setTimeout(async () => {
        const fields = document.getElementById('modalFields');
        if (!fields) return;

        // Evita duplicar el campo si ya existe
        if (!fields.querySelector('#ventaPersonal')) {
          const tpl = document.getElementById('tpl-venta-personal');
          if (tpl && 'content' in document.createElement('template')) {
            fields.prepend(tpl.content.cloneNode(true));
          } else {
            // Fallback si <template> no est√° soportado
            const wrap = document.createElement('div');
            wrap.className = 'form-row';
            wrap.setAttribute('data-field','venta-personal');
            wrap.innerHTML = '<label for="ventaPersonal">Atendido por</label><select id="ventaPersonal" name="idPersonal"><option value="">Cargando‚Ä¶</option></select>';
            fields.prepend(wrap);
          }
        }

        const sel = document.getElementById('ventaPersonal');
        if (sel) await loadPersonalOptions(sel);
      }, 0);
    });
  });
})();
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.kpi.is-action[data-target]').forEach(card=>{
      card.addEventListener('click', ()=>{
        const id = card.getAttribute('data-target');
        const link = document.querySelector(`.nav a[data-section="${id}"]`);
        if (link) link.click();
      });
    });
  });
</script>
</body>
</html>
